#!/usr/bin/env python

# SPDX-FileCopyrightText: (c) 2020 Western Digital Corporation or its affiliates,
#                             Arseniy Aharonov <arseniy@aharonov.icu>
#
# SPDX-License-Identifier: MIT

import os

import stat_attributes as attributes
from services import toPosixPath, isWindows, mkdir
from stat_configuration import StatConfiguration
from build_tools_crawler import BuildToolsCrawler

_makFileTemplate = """# Makefile autogenerated by STAT
{configuration}
PRODUCT_FLAVOR = {name}
OUTPUT_EXEC = {name}{extension}

include {product_file_path}
include {tool_path}/components.mak
include {tool_path}/build/stat_executive.mak
"""


class StatMakefileGenerator(object):
    def __init__(self, productMakefile):
        self.__targetName = productMakefile.split('.')[0]
        self.__productFilePath = '/'.join([toPosixPath(attributes.PRODUCT_DIRECTORY), productMakefile])
        if not os.path.isfile(self.__productFilePath):
            raise StatMakefileGeneratorException("The product file '{0}' was not found".format(self.__productFilePath))

    def generate(self):
        config = StatConfiguration()
        # noinspection PyTypeChecker
        values = {key: config[key] for key in config}
        values.update(BuildToolsCrawler().retrieve().getAttributes())
        configuration = '\n'.join(['{0} = {1}'.format(key, values[key]) for key in values])
        fileContext = _makFileTemplate.format(configuration=configuration,
                                              name=self.__targetName,
                                              extension='.exe' if isWindows() else '',
                                              tool_path=toPosixPath(os.path.relpath(attributes.TOOL_PATH)),
                                              product_file_path=self.__productFilePath)
        fileName = attributes.AUTO_GENERATED_MAKEFILE
        directory = os.path.dirname(fileName)
        mkdir(directory, exist_ok=True)
        fileHandle = open(fileName, 'w')
        fileHandle.write(fileContext)
        fileHandle.flush()
        fileHandle.close()


class StatMakefileGeneratorException(Exception):
    """
    Custom exception for STAT mak-file generator
    """
